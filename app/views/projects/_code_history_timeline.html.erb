<%= turbo_frame_tag "code-history-timeline" do %>
  <div class="space-y-4">
    <% if @pull_requests.empty? %>
<div class="text-center py-12 text-gray-500">
        <%= heroicon "document-text", options: { class: "mx-auto h-12 w-12 text-gray-300" } %>
        <p class="mt-2 text-sm font-medium">No merged pull requests found.</p>
      </div>
    <% else %>
      <% @pull_requests.each do |pr| %>
        <% update = @updates_by_pr[pr[:number]] %>
        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow"
             id="<%= "code-history-pr-#{pr[:number]}" %>">
          <div class="flex items-start gap-4">
            <!-- PR Author Avatar -->
            <img src="<%= pr[:user][:avatar_url] %>"
                 alt="<%= pr[:user][:login] %>"
                 class="w-10 h-10 rounded-full flex-shrink-0">

            <div class="flex-1 min-w-0">
              <!-- PR Title & Link -->
              <div class="flex items-center gap-2">
                <%= link_to pr[:html_url], target: "_blank",
                    class: "font-medium text-gray-900 hover:text-indigo-600 truncate" do %>
                  <%= pr[:title] %>
                <% end %>
              </div>

              <!-- PR Metadata -->
              <p class="text-sm text-gray-500 mt-1">
                #<%= pr[:number] %> merged <%= time_ago_in_words(pr[:merged_at]) %> ago
                by <%= pr[:user][:login] %>
              </p>

              <!-- Analysis Status / Content Preview -->
              <% if update %>
                <div class="mt-3 p-3 bg-gray-50 rounded-md">
                  <% if update.analysis_status == "running" %>
<div class="flex items-center gap-2 text-indigo-600 text-sm">
                      <%= spinner_icon(size: "w-4 h-4") %>
                      <span>Analyzing pull request...</span>
                    </div>
                  <% elsif update.analysis_status == "completed" %>
                    <% if update.content.present? %>
                      <p class="text-sm text-gray-700 line-clamp-2"><%= truncate(update.content, length: 150) %></p>
                    <% end %>
                    <div class="mt-2 flex items-center gap-2">
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        Analyzed
                      </span>
                      <% if update.recommendations.any? %>
                        <span class="text-xs text-gray-500">
                          <%= update.recommendations.count %> article suggestion<%= update.recommendations.count == 1 ? '' : 's' %>
                        </span>
                      <% end %>
                    </div>
                  <% elsif update.analysis_status == "failed" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                      Analysis failed
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                      <%= update.analysis_status&.humanize || "Pending" %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>

            <!-- Actions -->
            <div class="flex-shrink-0">
              <%= render "updates/pr_row_actions",
                  update: update,
                  project: project,
                  pr_number: pr[:number],
                  pr_title: pr[:title],
                  pr_url: pr[:html_url] %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @has_more %>
        <div class="text-center py-4">
          <%= link_to "Load more pull requests",
              code_history_project_path(project, page: @page + 1),
              class: "text-indigo-600 hover:text-indigo-800 text-sm font-medium",
              data: { turbo_frame: "code-history-timeline" } %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
