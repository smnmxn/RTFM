<div data-controller="inbox"
     data-project-slug="<%= project.slug %>"
     data-inbox-selected-type-value="<%= selected_article ? 'article' : (selected_recommendation ? 'recommendation' : '') %>"
     data-inbox-selected-id-value="<%= selected_article&.id || selected_recommendation&.id %>"
     class="flex-1 flex flex-col min-h-0">

  <!-- Hidden container for broadcast notifications -->
  <div id="inbox-notifications" data-inbox-target="notificationContainer" class="hidden"></div>

  <!-- Generation Status Banner -->
  <% if project.sections_being_generated? %>
    <div class="px-4 py-3 bg-gradient-brand text-white text-sm flex items-center justify-center flex-shrink-0">
      <%= spinner_icon(size: "h-4 w-4", extra_class: "mr-2") %>
      Generating topic suggestions...
    </div>
  <% elsif project.sections.accepted.where(recommendations_status: "running").any? %>
    <div class="px-4 py-3 bg-gradient-brand text-white text-sm flex items-center justify-center flex-shrink-0">
      <%= spinner_icon(size: "h-4 w-4", extra_class: "mr-2") %>
      Generating article suggestions...
    </div>
  <% end %>

  <!-- Update Notification Banner (hidden by default) -->
  <div data-inbox-target="notification"
       class="hidden px-4 py-2 bg-blue-50 border-b border-blue-100 text-blue-700 text-sm flex items-center justify-between flex-shrink-0">
    <span class="flex items-center gap-2">
      <%= heroicon "arrow-path", options: { class: "h-4 w-4" } %>
      Article content has been updated.
    </span>
    <button data-action="inbox#refreshEditor"
            class="text-blue-600 hover:text-blue-800 font-medium underline">
      Refresh
    </button>
  </div>

  <!-- Inbox Header -->
  <div class="px-6 py-4 border-b app-border flex-shrink-0">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold app-text">Inbox</h2>
        <p class="mt-1 text-sm app-text-secondary">
          Review suggestions and articles for your Help Centre.
        </p>
      </div>
      <%= render "projects/inbox_progress", project: project %>
    </div>
  </div>

  <!-- Split View -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Left Panel: Inbox List -->
    <div class="w-80 flex-shrink-0 border-r app-border flex flex-col app-bg">
      <div id="inbox-list" class="flex-1 overflow-y-auto">
        <% if inbox_empty %>
          <!-- Empty state message -->
          <div id="inbox-empty-state" class="p-6 text-center app-text-secondary">
            <%= heroicon "check", options: { class: "mx-auto h-12 w-12 app-text-muted" } %>
            <p class="mt-2 text-sm font-medium app-text">All done!</p>
            <p class="mt-1 text-xs app-text-muted">No pending items to review.</p>
          </div>
          <!-- Always render section wrappers for broadcast targets -->
          <div id="articles-section" class="hidden"></div>
          <div id="recommendations-section" class="hidden"></div>
        <% else %>
          <!-- Empty state (hidden, for broadcast updates) -->
          <div id="inbox-empty-state" class="hidden p-6 text-center app-text-secondary">
            <%= heroicon "check", options: { class: "mx-auto h-12 w-12 app-text-muted" } %>
            <p class="mt-2 text-sm font-medium app-text">All done!</p>
            <p class="mt-1 text-xs app-text-muted">No pending items to review.</p>
          </div>
          <!-- Articles Section (higher priority) -->
          <%= render "projects/inbox_articles_section",
              inbox_articles: inbox_articles,
              selected_article_id: selected_article&.id %>

          <!-- Suggestions Section -->
          <%= render "projects/recommendations_section",
              pending_recommendations: pending_recommendations,
              selected_recommendation_id: (selected_recommendation&.id if selected_article.nil?) %>
        <% end %>
      </div>
    </div>

    <!-- Right Panel: Editor -->
    <div data-inbox-target="editor" class="flex-1 flex flex-col overflow-hidden app-bg">
      <% if inbox_empty %>
        <%= render "projects/all_reviewed", project: project %>
      <% elsif selected_article %>
        <%= render "projects/article_editor", article: selected_article %>
      <% elsif selected_recommendation %>
        <%= render "projects/recommendation_editor", recommendation: selected_recommendation %>
      <% else %>
        <%= turbo_frame_tag "inbox-editor", class: "h-full block" do %>
          <div class="h-full flex items-center justify-center app-surface">
            <div class="text-center px-6">
              <%= heroicon "document-text", options: { class: "mx-auto h-16 w-16 app-text-muted" } %>
              <h3 class="mt-4 text-lg font-medium app-text">Select an item</h3>
              <p class="mt-2 text-sm app-text-secondary">
                Choose an item from the list to review.
              </p>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
