<div class="app-bg min-h-screen">
  <%= render "shared/app_header" %>

  <main class="max-w-5xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <% if flash[:notice] %>
      <div class="mb-6 app-success-bg border app-success-text px-4 py-3 rounded-lg" style="border-color: var(--app-success-border);">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- Page header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-2xl font-bold app-text" style="font-family: var(--app-font-display);">Projects</h1>
        <p class="mt-1 text-sm app-text-secondary">Select a project to manage its help centre.</p>
      </div>
      <%= link_to new_onboarding_project_path, class: "btn-primary-md inline-flex items-center gap-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
        </svg>
        New Project
      <% end %>
    </div>

    <% if @projects.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <% @projects.each do |project| %>
          <% if project.in_onboarding? %>
            <!-- Onboarding card -->
            <%= link_to send("#{project.onboarding_step}_onboarding_project_path", project),
                  class: "block app-surface rounded-xl border app-border app-shadow-sm hover-lift" do %>
              <div class="p-5">
                <!-- Top row -->
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg app-warning-bg flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 app-warning-text" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M13.5 4.938a7 7 0 1 1-9.006 1.737c.28-.257.611-.39.907-.39.352 0 .648.15.86.348a3.5 3.5 0 0 0 4.914.066l.168-.153c.226-.206.504-.336.867-.336.404 0 .782.197 1.034.536l.255.343A6.967 6.967 0 0 0 13.5 4.938ZM10 16.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="min-w-0 flex-1">
                    <h3 class="text-base font-semibold app-text truncate" style="font-family: var(--app-font-display);"><%= project.name %></h3>
                    <p class="text-xs app-warning-text font-medium">Setup incomplete</p>
                  </div>
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 app-text-muted flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                  </svg>
                </div>

                <!-- Progress bar -->
                <div class="mt-4">
                  <div class="flex items-center justify-between mb-1.5">
                    <span class="text-xs app-text-muted">Step <%= project.onboarding_step_number %> of 4</span>
                  </div>
                  <div class="w-full h-1.5 rounded-full" style="background-color: var(--app-border);">
                    <div class="h-1.5 rounded-full bg-gradient-connector" style="width: <%= project.onboarding_step_number * 25 %>%;"></div>
                  </div>
                </div>

                <!-- CTA -->
                <div class="mt-4 flex items-center gap-1 text-sm font-medium app-accent-text">
                  Continue setup
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
            <% end %>

          <% else %>
            <!-- Completed project card (stretched-link pattern for multiple clickable targets) -->
            <div class="relative app-surface rounded-xl border app-border app-shadow-sm hover-lift">
              <%= link_to project_path(project), class: "absolute inset-0 z-0 rounded-xl", "aria-label": "Open #{project.name}" do %><% end %>
              <div class="relative z-10 pointer-events-none p-5">
                <!-- Top row: logo + name + repo + chevron -->
                <div class="flex items-center gap-3">
                  <% if project.logo.attached? %>
                    <div class="w-10 h-10 rounded-lg app-surface-alt flex items-center justify-center flex-shrink-0 overflow-hidden">
                      <%= image_tag project.logo, class: "max-w-full max-h-full object-contain" %>
                    </div>
                  <% else %>
                    <div class="w-10 h-10 rounded-lg bg-gradient-brand flex items-center justify-center flex-shrink-0">
                      <span class="text-white text-sm font-bold" style="font-family: var(--app-font-display);"><%= project.name[0].upcase %></span>
                    </div>
                  <% end %>
                  <div class="min-w-0 flex-1">
                    <h3 class="text-base font-semibold app-text truncate" style="font-family: var(--app-font-display);"><%= project.name %></h3>
                    <p class="text-xs app-text-muted truncate"><%= project.primary_github_repo %></p>
                  </div>
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 app-text-muted flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                  </svg>
                </div>

                <!-- Running jobs indicator -->
                <% if project.has_running_jobs? %>
                  <div class="mt-3 flex items-center gap-2 text-xs app-text-secondary">
                    <svg class="animate-spin w-3.5 h-3.5 app-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    Processing...
                  </div>
                <% end %>

                <!-- Stats row -->
                <div class="mt-4 pt-4 border-t app-border">
                  <div class="grid grid-cols-3 gap-4">
                    <% inbox_count = project.articles.where(review_status: :unreviewed).count + project.recommendations.pending.count %>
                    <div class="text-center">
                      <div class="flex items-center justify-center gap-1">
                        <% if inbox_count > 0 %>
                          <span class="w-1.5 h-1.5 rounded-full bg-amber-400 flex-shrink-0"></span>
                        <% end %>
                        <span class="text-lg font-semibold app-text" style="font-family: var(--app-font-display);"><%= inbox_count %></span>
                      </div>
                      <span class="text-xs app-text-muted">Inbox</span>
                    </div>
                    <div class="text-center">
                      <span class="text-lg font-semibold app-text" style="font-family: var(--app-font-display);"><%= project.articles.where(review_status: :approved).count %></span>
                      <br>
                      <span class="text-xs app-text-muted">Articles</span>
                    </div>
                    <div class="text-center">
                      <span class="text-lg font-semibold app-text" style="font-family: var(--app-font-display);"><%= project.sections.visible.count %></span>
                      <br>
                      <span class="text-xs app-text-muted">Sections</span>
                    </div>
                  </div>
                </div>

                <!-- Help centre link -->
                <div class="mt-4 pt-3 border-t app-border">
                  <%= link_to project_help_centre_url(project), target: "_blank", rel: "noopener",
                        class: "pointer-events-auto inline-flex items-center gap-1.5 text-xs font-medium app-text-secondary hover:app-text transition-smooth" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Zm7.25-.75a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V6.31l-5.47 5.47a.75.75 0 1 1-1.06-1.06l5.47-5.47H12.25a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                    </svg>
                    View help centre
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <!-- Empty state -->
      <div class="text-center py-16 app-surface rounded-xl border app-border app-shadow-sm">
        <div class="mx-auto w-16 h-16 rounded-2xl app-surface-alt flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 app-text-muted" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold app-text" style="font-family: var(--app-font-display);">No projects yet</h3>
        <p class="mt-1 text-sm app-text-secondary">Get started by connecting a GitHub repository.</p>
        <div class="mt-6">
          <%= link_to new_onboarding_project_path, class: "btn-primary-md inline-flex items-center gap-2" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
            </svg>
            Create your first project
          <% end %>
        </div>
      </div>
    <% end %>
  </main>
</div>
