<!-- Articles Header -->
<div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">Articles</h2>
      <p class="mt-1 text-sm text-gray-500">
        Manage published articles in your Help Centre.
      </p>
    </div>
    <div>
      <%= render "articles/new_article_modal", project: project %>
    </div>
  </div>
</div>

<!-- Three Column Layout -->
<%# Use preselected article/section if provided, otherwise default to first %>
<% active_section = local_assigns[:preselected_section] || sections.find { |s| s.articles.for_editor.any? } %>
<% is_uncategorized = local_assigns[:preselected_article] && local_assigns[:preselected_section].nil? %>

<div class="flex-1 flex overflow-hidden">
  <!-- Left: Sections Sidebar -->
  <div class="w-56 flex-shrink-0 border-r border-gray-200 flex flex-col bg-gray-50">
    <div class="px-4 py-3 border-b border-gray-200 bg-gray-100 flex items-center justify-between">
      <h3 class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Sections</h3>
      <%= render "sections/new_section_modal", project: project %>
    </div>
    <div id="articles-sections-list" class="flex-1 overflow-y-auto">
      <% sections.each do |section| %>
        <% article_count = section.articles.for_editor.count %>
        <%= render "projects/articles_section_row",
            section: section,
            article_count: article_count,
            selected: !is_uncategorized && active_section&.id == section.id,
            project: project %>
      <% end %>

      <% if uncategorized_count > 0 %>
        <div class="border-t border-gray-200 mt-2 pt-2">
          <%= render "projects/articles_section_row",
              section: nil,
              article_count: uncategorized_count,
              selected: is_uncategorized || (active_section.nil? && !local_assigns[:preselected_article]),
              project: project %>
        </div>
      <% end %>

      <% if sections.empty? && uncategorized_count == 0 %>
        <div class="p-4 text-center text-gray-500 text-sm">
          No sections yet
        </div>
      <% end %>
    </div>
  </div>

  <!-- Middle: Articles List -->
  <div class="w-72 flex-shrink-0 border-r border-gray-200 flex flex-col bg-white">
    <% if is_uncategorized %>
      <% initial_articles = project.articles.for_editor.where(section: nil).ordered %>
    <% elsif active_section %>
      <% initial_articles = active_section.articles.for_editor.ordered %>
    <% else %>
      <% initial_articles = uncategorized_count > 0 ? project.articles.for_editor.where(section: nil).ordered : [] %>
    <% end %>

    <%= turbo_frame_tag "articles-list-frame" do %>
      <%= render "projects/articles_list",
          articles: initial_articles,
          section: is_uncategorized ? nil : active_section,
          project: project,
          selected_article_id: local_assigns[:preselected_article]&.id %>
    <% end %>
  </div>

  <!-- Right: Article Editor -->
  <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">
    <%= turbo_frame_tag "articles-editor-frame", class: "h-full" do %>
      <% display_article = local_assigns[:preselected_article] || initial_articles.first %>
      <% if display_article %>
        <%= render "projects/articles_editor",
            article: display_article,
            project: project,
            sections: sections %>
      <% else %>
        <%= render "projects/articles_empty_state" %>
      <% end %>
    <% end %>
  </div>
</div>
