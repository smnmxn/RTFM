<%= turbo_frame_tag "custom_domain_form" do %>
  <div class="space-y-6">
    <!-- Success/Error Messages -->
    <% if local_assigns[:saved] && saved %>
      <div class="rounded-md bg-green-50 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <%= heroicon "check-circle", options: { class: "h-5 w-5 text-green-400" } %>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-green-800">Changes saved successfully.</p>
          </div>
        </div>
      </div>
    <% end %>

    <% if local_assigns[:checking] && checking %>
      <div class="rounded-md bg-blue-50 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <%= heroicon "arrow-path", options: { class: "h-5 w-5 text-blue-400 animate-spin" } %>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-blue-800">Checking domain status... This page will refresh automatically.</p>
          </div>
        </div>
      </div>
    <% end %>

    <% if project.errors[:custom_domain].any? %>
      <div class="rounded-md bg-red-50 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <%= heroicon "x-circle", options: { class: "h-5 w-5 text-red-400" } %>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-red-800"><%= project.errors[:custom_domain].join(", ") %></p>
          </div>
        </div>
      </div>
    <% end %>

    <div class="border border-gray-200 rounded-lg">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg">
        <h3 class="text-lg font-medium text-gray-900">Custom Domain</h3>
        <p class="text-sm text-gray-500 mt-1">Use your own domain for your Help Centre (e.g., help.yourcompany.com).</p>
      </div>

      <div class="p-4 space-y-4">
        <% if project.custom_domain.blank? %>
          <!-- No domain configured - show input form -->
          <%= form_with model: project, url: update_custom_domain_project_path(project), method: :patch, class: "space-y-4" do |f| %>
            <div>
              <label for="project_custom_domain" class="block text-sm font-medium text-gray-700">Custom Domain</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                  https://
                </span>
                <%= f.text_field :custom_domain,
                    placeholder: "help.yourcompany.com",
                    class: "flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">Enter your custom domain without the protocol (https://).</p>
            </div>

            <div class="flex justify-end">
              <%= f.submit "Add Custom Domain",
                  class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer" %>
            </div>
          <% end %>

        <% elsif project.custom_domain_pending? || project.custom_domain_verifying? %>
          <!-- Domain pending/verifying - show DNS instructions -->
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <% if project.custom_domain_verifying? %>
                  <%= heroicon "arrow-path", options: { class: "h-6 w-6 text-yellow-500 animate-spin" } %>
                <% else %>
                  <%= heroicon "clock", options: { class: "h-6 w-6 text-yellow-500" } %>
                <% end %>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900"><%= project.custom_domain %></p>
                <p class="text-sm text-yellow-600">
                  <% if project.custom_domain_verifying? %>
                    Verifying domain... This can take a few minutes.
                  <% else %>
                    Waiting for DNS configuration
                  <% end %>
                </p>
              </div>
            </div>

            <!-- DNS Instructions -->
            <div class="rounded-md bg-blue-50 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <%= heroicon "information-circle", options: { class: "h-5 w-5 text-blue-400" } %>
                </div>
                <div class="ml-3">
                  <h4 class="text-sm font-medium text-blue-800">DNS Configuration Required</h4>
                  <div class="mt-2 text-sm text-blue-700">
                    <p class="mb-3">Add the following CNAME record to your DNS provider:</p>

                    <div class="overflow-hidden rounded-md border border-blue-200 bg-white">
                      <table class="min-w-full divide-y divide-blue-200">
                        <thead class="bg-blue-100">
                          <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Type</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Name</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Target</th>
                          </tr>
                        </thead>
                        <tbody class="bg-white">
                          <tr>
                            <td class="px-3 py-2 text-sm font-mono text-blue-900">CNAME</td>
                            <td class="px-3 py-2 text-sm font-mono text-blue-900"><%= project.custom_domain.split('.').first %></td>
                            <td class="px-3 py-2 text-sm font-mono text-blue-900"><%= project.custom_domain_cname_target %></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <p class="mt-3">DNS changes can take up to 24 hours to propagate. We'll automatically verify once the records are active.</p>

                    <p class="mt-2 text-xs text-blue-600">
                      <strong>Using Cloudflare?</strong> Make sure the record is proxied (orange cloud).
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between pt-2">
              <%= button_to "Check Status",
                  verify_custom_domain_project_path(project),
                  method: :post,
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer" %>

              <%= button_to "Remove Domain",
                  remove_custom_domain_project_path(project),
                  method: :delete,
                  data: { turbo_confirm: "Are you sure you want to remove this custom domain?" },
                  class: "inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer" %>
            </div>
          </div>

        <% elsif project.custom_domain_active? %>
          <!-- Domain active - show success state -->
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <%= heroicon "check-circle", options: { class: "h-6 w-6 text-green-500" } %>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-gray-900"><%= project.custom_domain %></p>
                <p class="text-sm text-green-600">Active and serving traffic</p>
              </div>
              <a href="https://<%= project.custom_domain %>" target="_blank" rel="noopener" class="inline-flex items-center text-sm text-indigo-600 hover:text-indigo-500">
                Visit
                <%= heroicon "arrow-top-right-on-square", options: { class: "ml-1 h-4 w-4" } %>
              </a>
            </div>

            <% if project.custom_domain_verified_at.present? %>
              <p class="text-xs text-gray-500">
                Verified <%= time_ago_in_words(project.custom_domain_verified_at) %> ago
                <% if project.custom_domain_ssl_status.present? %>
                  &middot; SSL: <%= project.custom_domain_ssl_status %>
                <% end %>
              </p>
            <% end %>

            <div class="flex justify-end pt-2">
              <%= button_to "Remove Domain",
                  remove_custom_domain_project_path(project),
                  method: :delete,
                  data: { turbo_confirm: "Are you sure you want to remove this custom domain? Your Help Centre will no longer be accessible at #{project.custom_domain}." },
                  class: "inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer" %>
            </div>
          </div>

        <% elsif project.custom_domain_failed? %>
          <!-- Domain failed - show error and retry option -->
          <div class="space-y-4">
            <div class="rounded-md bg-red-50 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <%= heroicon "x-circle", options: { class: "h-5 w-5 text-red-400" } %>
                </div>
                <div class="ml-3">
                  <h4 class="text-sm font-medium text-red-800">Domain Setup Failed</h4>
                  <div class="mt-2 text-sm text-red-700">
                    <p>
                      <strong><%= project.custom_domain %></strong> could not be verified.
                      <% if project.custom_domain_ssl_status.present? %>
                        Error: <%= project.custom_domain_ssl_status %>
                      <% end %>
                    </p>
                    <p class="mt-2">Please check your DNS configuration and try again, or remove the domain and add it again.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <%= button_to "Retry Verification",
                  verify_custom_domain_project_path(project),
                  method: :post,
                  class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer" %>

              <%= button_to "Remove Domain",
                  remove_custom_domain_project_path(project),
                  method: :delete,
                  data: { turbo_confirm: "Are you sure you want to remove this custom domain?" },
                  class: "inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Help text -->
    <div class="text-sm text-gray-500">
      <p class="font-medium text-gray-700 mb-2">How custom domains work:</p>
      <ol class="list-decimal list-inside space-y-1">
        <li>Enter your desired custom domain (e.g., help.yourcompany.com)</li>
        <li>Add the CNAME record to your DNS provider</li>
        <li>We'll automatically verify the DNS and provision an SSL certificate</li>
        <li>Once active, your Help Centre will be accessible at your custom domain</li>
      </ol>
    </div>
  </div>
<% end %>
