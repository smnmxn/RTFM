<%= turbo_frame_tag "code-history-timeline" do %>
  <div class="space-y-4">
    <% if @commits.empty? %>
<div class="text-center py-12 app-text-secondary">
        <%= heroicon "document-text", options: { class: "mx-auto h-12 w-12 app-text-muted" } %>
        <p class="mt-2 text-sm font-medium">No commits found.</p>
      </div>
    <% else %>
      <%# Find the baseline commit's date from the list, or use analyzed_at as fallback %>
      <% baseline_commit = @commits.find { |c| c[:sha] == project.analysis_commit_sha } %>
      <% baseline_date = baseline_commit&.dig(:committed_at) || project.analyzed_at %>
      <% @commits.each do |commit| %>
        <% update = @updates_by_commit[commit[:sha]] %>
        <% is_analysis_baseline = commit[:sha] == project.analysis_commit_sha %>
        <% last_check = project.article_update_checks.completed.recent.first %>
        <% is_last_check = last_check && commit[:sha] == last_check.target_commit_sha %>
        <div class="<%= is_analysis_baseline ? 'app-accent-light border-[color:var(--app-accent)]' : (is_last_check ? 'bg-green-50 border-green-200' : 'app-surface app-border') %> border rounded-lg p-4 hover:shadow-sm transition-shadow"
             id="<%= "code-history-commit-#{commit[:short_sha]}" %>">
          <div class="flex items-start gap-4">
            <!-- Author Avatar -->
            <img src="<%= commit[:author][:avatar_url] %>"
                 alt="<%= commit[:author][:login] %>"
                 class="w-10 h-10 rounded-full flex-shrink-0">

            <div class="flex-1 min-w-0">
              <!-- Commit Title & Link -->
              <div class="flex items-center gap-2 flex-wrap">
                <%= link_to commit[:html_url], target: "_blank",
                    class: "font-medium app-text hover:app-accent-text truncate" do %>
                  <%= commit[:title] %>
                <% end %>
                <span class="text-xs font-mono app-text-muted flex-shrink-0"><%= commit[:short_sha] %></span>
                <% if is_analysis_baseline %>
                  <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium app-accent-light app-accent-on-light">
                    <%= heroicon "flag", options: { class: "w-3 h-3" } %>
                    Docs baseline
                  </span>
                <% end %>
                <% if is_last_check %>
                  <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">
                    <%= heroicon "arrow-path", options: { class: "w-3 h-3" } %>
                    Last check
                  </span>
                <% end %>
              </div>

              <!-- Commit Metadata -->
              <p class="text-sm app-text-secondary mt-1">
                committed <%= time_ago_in_words(commit[:committed_at]) %> ago
                by <%= commit[:author][:login] %>
              </p>

              <!-- Analysis Status / Content Preview -->
              <% if update %>
                <div class="mt-3 p-3 app-surface-alt rounded-md">
                  <% if update.analysis_status == "running" %>
<div class="flex items-center gap-2 app-accent-text text-sm">
                      <%= spinner_icon(size: "w-4 h-4") %>
                      <span>Analyzing commit...</span>
                    </div>
                  <% elsif update.analysis_status == "completed" %>
                    <% if update.content.present? %>
                      <p class="text-sm app-text line-clamp-2"><%= truncate(update.content, length: 150) %></p>
                    <% end %>
                    <div class="mt-2 flex items-center gap-2 flex-wrap">
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        Analyzed
                      </span>
                      <% if update.recommendations.any? %>
                        <span class="text-xs app-text-secondary">
                          <%= update.recommendations.count %> article suggestion<%= update.recommendations.count == 1 ? '' : 's' %>
                        </span>
                      <% elsif update.analysis_reason.present? %>
                        <span class="text-xs app-text-secondary italic">
                          <%= truncate(update.analysis_reason, length: 100) %>
                        </span>
                      <% end %>
                    </div>
                  <% elsif update.analysis_status == "failed" %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                      Analysis failed
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                      <%= update.analysis_status&.humanize || "Pending" %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>

            <!-- Actions -->
            <div class="flex-shrink-0">
              <% is_prior_to_baseline = baseline_date.present? && commit[:committed_at] < baseline_date %>
              <%= render "updates/commit_row_actions",
                  update: update,
                  project: project,
                  commit: commit,
                  is_prior_to_baseline: is_prior_to_baseline %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @has_more %>
        <div class="text-center py-4">
          <%= link_to "Load more commits",
              code_history_project_path(project, view: "commits", page: @page + 1),
              class: "app-accent-text hover:app-accent-hover text-sm font-medium",
              data: { turbo_frame: "code-history-timeline" } %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
