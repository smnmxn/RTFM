<%# locals: (section:, articles:, project:, selected_article_id:) %>

<div id="folder-section-<%= section&.id || 'uncategorized' %>"
     data-controller="folder-section <%= 'section-menu' if section.present? %>"
     data-folder-section-expanded-value="true"
     <%= "data-section-menu-delete-url-value=#{project_section_path(project, section)}" if section.present? %>
     class="group/section">

  <!-- Section Header -->
  <div class="relative flex items-center px-3 py-2 hover:app-surface-alt cursor-pointer">
    <button type="button"
            data-action="click->folder-section#toggle click->articles-panel#trackSectionToggle"
            class="flex items-center gap-2 flex-1 text-left min-w-0">
      <span data-folder-section-target="chevron" class="transition-transform duration-200 app-text-muted rotate-90 flex-shrink-0">
        <%= heroicon "chevron-right", options: { class: "w-4 h-4" } %>
      </span>
      <%= heroicon section&.icon_name || "folder", options: { class: "w-4 h-4 app-text-secondary flex-shrink-0" } %>
      <span class="font-medium text-sm app-text-secondary truncate"><%= section&.name || "Uncategorized" %></span>
      <span class="text-xs app-text-muted flex-shrink-0">(<%= articles.count %>)</span>
    </button>

    <% if section.present? %>
      <!-- Add article button -->
      <button type="button"
              data-controller="add-article-button"
              data-add-article-button-section-id-value="<%= section.id %>"
              data-action="add-article-button#open"
              class="p-1 app-text-muted hover:app-text opacity-0 group-hover/section:opacity-100 transition-opacity flex-shrink-0"
              title="Add article to <%= section.name %>">
        <%= heroicon "plus", options: { class: "w-4 h-4" } %>
      </button>

      <!-- Kebab menu -->
      <button type="button"
              data-action="section-menu#toggle"
              class="p-1 app-text-muted hover:app-text opacity-0 group-hover/section:opacity-100 transition-opacity flex-shrink-0">
        <%= heroicon "ellipsis-vertical", options: { class: "w-4 h-4" } %>
      </button>

      <!-- Dropdown menu -->
      <div data-section-menu-target="menu"
           class="hidden absolute right-0 top-full mt-1 w-32 app-surface rounded-lg shadow-lg border app-border py-1 z-10">
        <button type="button"
                data-action="section-menu#openEdit"
                class="w-full flex items-center gap-2 px-3 py-2 text-sm app-text-secondary hover:app-surface-alt text-left">
          <%= heroicon "pencil", options: { class: "w-4 h-4" } %>
          Edit
        </button>
        <button type="button"
                data-action="section-menu#delete"
                class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 text-left">
          <%= heroicon "trash", options: { class: "w-4 h-4" } %>
          Delete
        </button>
      </div>

      <!-- Edit Modal -->
      <%= render "sections/edit_section_modal", section: section, project: project %>
    <% end %>
  </div>

  <!-- Nested Articles -->
  <div data-folder-section-target="content"
       data-controller="sortable"
       data-sortable-url-value="<%= bulk_reorder_project_articles_path(project) %>"
       data-sortable-group-value="articles"
       data-sortable-section-value="<%= section&.id || 'uncategorized' %>"
       class="pl-6">
    <% if articles.any? %>
      <% articles.each do |article| %>
        <%= render "projects/articles_folder_article",
            article: article,
            project: project,
            selected: article.id.to_s == selected_article_id.to_s %>
      <% end %>
    <% else %>
      <div class="py-2 text-xs app-text-muted pl-6">
        No articles
      </div>
    <% end %>
  </div>
</div>
