<% frame_id = @page == 1 ? "code-history-timeline" : "code-history-page-#{@page}" %>
<%= turbo_frame_tag frame_id do %>
  <div class="space-y-3">
    <% if @timeline_items.empty? && @page == 1 %>
      <div class="text-center py-12 app-text-secondary">
        <%= heroicon "document-text", options: { class: "mx-auto h-12 w-12 app-text-muted" } %>
        <p class="mt-2 text-sm font-medium">No commits or pull requests found.</p>
      </div>
    <% else %>
      <% any_running = @timeline_items.any? { |i| i[:update]&.analysis_status == "running" } %>
      <% shown_latest_recommendation = @latest_recommendation_shown %>
      <% @timeline_items.each do |item| %>
        <% update = item[:update] %>
        <% is_commit = item[:type] == :commit %>
        <% is_analysis_baseline = (is_commit && item[:sha] == project.analysis_commit_sha) ||
                                   (!is_commit && item[:merge_commit_sha] == project.analysis_commit_sha) %>
        <% last_check = project.article_update_checks.completed.recent.first %>
        <% is_last_check = is_commit && last_check && item[:sha] == last_check.target_commit_sha %>
        <% is_before_cutoff = @analysis_cutoff_date.present? && item[:date] <= @analysis_cutoff_date %>
        <% has_analysis = update.present? && update.analysis_status.present? %>

        <div class="rounded-lg overflow-hidden border <%= has_analysis && update.analysis_status == 'completed' ? 'app-border-strong app-shadow-sm' : 'app-border' %>">
          <!-- Analysis Result Row (ABOVE the commit/PR) -->
          <% if has_analysis %>
            <div id="<%= is_commit ? "code-history-analysis-#{item[:short_sha]}" : "code-history-analysis-pr-#{item[:pr_number]}" %>">
              <% if update.analysis_status == "running" %>
                <div class="app-accent-light px-5 py-4 border-b app-border">
                  <div class="flex items-center gap-3 app-accent-on-light">
                    <%= spinner_icon(size: "w-5 h-5") %>
                    <span class="font-medium">Analyzing <%= is_commit ? 'commit' : 'pull request' %>...</span>
                  </div>
                </div>
              <% elsif update.analysis_status == "completed" %>
                <% if update.recommendations.any? %>
                  <% is_latest_recommendation = !shown_latest_recommendation %>
                  <% shown_latest_recommendation = true %>
                  <% if is_latest_recommendation %>
                    <!-- Latest recommendations - prominent accent banner -->
                    <div class="app-accent-bg px-5 py-4">
                      <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                          <%= heroicon "light-bulb", options: { class: "w-5 h-5 text-white" } %>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-lg font-semibold text-white">
                              <%= update.recommendations.count %> article suggestion<%= update.recommendations.count == 1 ? '' : 's' %>
                            </span>
                          </div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <% update.recommendations.limit(4).each do |rec| %>
                              <span class="inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-white/20 text-white">
                                <%= truncate(rec.title, length: 45) %>
                              </span>
                            <% end %>
                            <% if update.recommendations.count > 4 %>
                              <span class="text-sm app-text-muted">+<%= update.recommendations.count - 4 %> more</span>
                            <% end %>
                          </div>
                        </div>
                        <% first_rec = update.recommendations.first %>
                        <% if first_rec %>
                          <div class="flex-shrink-0">
                            <%= link_to "Review",
                                project_path(project, selected: "recommendation_#{first_rec.id}"),
                                class: "inline-flex items-center px-3 py-1.5 text-sm font-medium app-accent-text app-surface hover:app-surface-alt rounded-md",
                                data: { turbo_frame: "_top" } %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% else %>
                    <!-- Older recommendations - subtle grey banner -->
                    <div class="app-surface-alt px-5 py-4 border-b app-border">
                      <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full app-surface-alt flex items-center justify-center">
                          <%= heroicon "light-bulb", options: { class: "w-5 h-5 app-text-secondary" } %>
                        </div>
                        <div class="flex-1 min-w-0">
                          <span class="text-base font-semibold app-text-secondary">
                            <%= update.recommendations.count %> article suggestion<%= update.recommendations.count == 1 ? '' : 's' %>
                          </span>
                          <div class="mt-1 flex flex-wrap gap-1.5">
                            <% update.recommendations.limit(4).each do |rec| %>
                              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium app-surface-alt app-text-secondary">
                                <%= truncate(rec.title, length: 45) %>
                              </span>
                            <% end %>
                            <% if update.recommendations.count > 4 %>
                              <span class="text-xs app-text-muted">+<%= update.recommendations.count - 4 %> more</span>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <!-- No recommendations - subtle gray banner -->
                  <div class="app-surface-alt px-5 py-4 border-b app-border">
                    <div class="flex items-start gap-4">
                      <div class="flex-shrink-0 w-10 h-10 rounded-full app-surface-alt flex items-center justify-center">
                        <%= heroicon "check", options: { class: "w-5 h-5 app-text-secondary" } %>
                      </div>
                      <div class="flex-1 min-w-0">
                        <span class="text-base font-semibold app-text-secondary">No documentation updates needed</span>
                        <% if update.analysis_reason.present? %>
                          <p class="mt-1 text-sm app-text-secondary leading-relaxed">
                            "<%= truncate(update.analysis_reason, length: 300) %>"
                          </p>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% elsif update.analysis_status == "failed" %>
                <div class="bg-red-50 px-5 py-4 border-b border-red-100">
                  <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                      <%= heroicon "x-mark", options: { class: "w-5 h-5 text-red-600" } %>
                    </div>
                    <span class="font-medium text-red-700">Analysis failed</span>
                  </div>
                </div>
              <% else %>
                <div class="bg-yellow-50 px-5 py-4 border-b border-yellow-100">
                  <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                      <%= heroicon "clock", options: { class: "w-5 h-5 text-yellow-600" } %>
                    </div>
                    <span class="font-medium text-yellow-700"><%= update.analysis_status&.humanize || "Pending" %></span>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Commit/PR Row (source context) -->
          <div class="<%= is_analysis_baseline ? 'app-accent-light' : (is_last_check ? 'bg-green-50' : 'app-surface') %> px-5 py-3"
               id="<%= is_commit ? "code-history-commit-#{item[:short_sha]}" : "code-history-pr-#{item[:pr_number]}" %>">
            <div class="flex items-center gap-4">
              <!-- Type indicator icon -->
              <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center <%= is_commit ? 'app-surface-alt' : 'app-accent-light' %>">
                <% if is_commit %>
                  <%= heroicon "code-bracket", variant: :mini, options: { class: "w-4 h-4 app-text-secondary" } %>
                <% else %>
                  <%= heroicon "arrow-path", variant: :mini, options: { class: "w-4 h-4 app-accent-text" } %>
                <% end %>
              </div>

              <div class="flex-1 min-w-0">
                <!-- Title & metadata on same line -->
                <div class="flex items-center gap-2 flex-wrap">
                  <%= link_to item[:url], target: "_blank",
                      class: "text-sm font-medium app-text-secondary hover:app-accent-text truncate" do %>
                    <%= item[:title] %>
                  <% end %>
                  <% if is_commit %>
                    <span class="text-xs font-mono app-text-muted"><%= item[:short_sha] %></span>
                  <% else %>
                    <span class="text-xs app-text-muted">#<%= item[:pr_number] %></span>
                  <% end %>
                  <span class="text-xs app-text-muted">&middot;</span>
                  <span class="text-xs app-text-secondary">
                    <% if is_commit %>
                      <%= time_ago_in_words(item[:date]) %> ago by <%= item[:author][:login] %>
                    <% else %>
                      merged <%= time_ago_in_words(item[:date]) %> ago by <%= item[:author][:login] %>
                    <% end %>
                  </span>
                  <% if is_analysis_baseline %>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium app-accent-light app-accent-on-light">
                      <%= heroicon "flag", options: { class: "w-3 h-3" } %>
                      Baseline
                    </span>
                  <% end %>
                  <% if is_last_check %>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">
                      <%= heroicon "arrow-path", options: { class: "w-3 h-3" } %>
                      Last check
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex-shrink-0">
                <%= render "updates/timeline_row_actions",
                    update: update,
                    project: project,
                    item: item,
                    is_before_cutoff: is_before_cutoff,
                    any_running: any_running %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <% if @has_more %>
        <%= turbo_frame_tag "code-history-page-#{@page + 1}" do %>
          <div class="text-center py-4">
            <%= link_to "Load more",
                code_history_project_path(project, page: @page + 1, latest_recommendation_shown: shown_latest_recommendation),
                class: "app-accent-text hover:app-accent-text text-sm font-medium" %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>
