<%= turbo_frame_tag "repository_list" do %>
  <div class="divide-y divide-[color:var(--app-border)]">
    <% if @installations.blank? %>
      <%# No GitHub App installed %>
      <div class="p-8 text-center">
        <div class="mx-auto w-12 h-12 rounded-full app-accent-light flex items-center justify-center mb-4">
          <%= heroicon "link", options: { class: "w-6 h-6 app-accent-text" } %>
        </div>
        <h3 class="text-lg font-medium app-text mb-2">Install the GitHub App</h3>
        <p class="app-text-secondary mb-6 max-w-sm mx-auto">
          To connect repositories, you need to install our GitHub App and grant access to the repos you want to document.
        </p>
        <% return_path = @onboarding_project.present? ? repository_onboarding_project_path(@onboarding_project) : new_project_path %>
        <%= link_to "Install GitHub App",
            github_app_install_path(return_to: return_path),
            class: "inline-flex items-center px-4 py-2 bg-gradient-brand text-white text-sm font-medium rounded-lg hover:opacity-90 transition-smooth",
            data: { turbo: false } %>
      </div>
    <% elsif @repositories.empty? %>
      <%# App installed but no repos accessible %>
      <div class="p-8 text-center">
        <p class="app-text-secondary mb-4">No repositories available.</p>
        <p class="text-sm app-text-muted mb-6">
          The GitHub App is installed but doesn't have access to any repositories yet.
        </p>
        <% return_path = @onboarding_project.present? ? repository_onboarding_project_path(@onboarding_project) : new_project_path %>
        <%= link_to "Configure Repository Access",
            github_app_install_path(return_to: return_path),
            class: "app-accent-text hover:app-accent-text transition-smooth",
            data: { turbo: false } %>
      </div>
    <% elsif @onboarding_project.present? %>
      <%# Onboarding mode - single-select by default, toggle to multi-select %>
      <div data-controller="repo-select" data-repo-select-mode-value="single">
        <%# Search input %>
        <% if @repositories.size > 5 %>
          <div class="p-4 border-b app-border">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <%= heroicon "magnifying-glass", options: { class: "h-5 w-5 app-text-muted" } %>
              </div>
              <input type="text"
                     placeholder="Search repositories..."
                     data-repo-select-target="searchInput"
                     data-action="input->repo-select#filter"
                     class="block w-full pl-10 pr-3 py-2 border app-border rounded-lg text-sm placeholder-[color:var(--app-text-muted)] focus:outline-none focus:ring-2 focus:ring-[color:var(--app-focus-ring)] focus:border-transparent" />
            </div>
          </div>
        <% end %>

        <%# No results message (hidden by default) %>
        <div class="p-8 text-center hidden" data-repo-select-target="noResults">
          <p class="app-text-secondary">No repositories match your search.</p>
        </div>

        <div class="divide-y divide-[color:var(--app-border)]" data-repo-select-target="repoList">
          <% @repositories.each_with_index do |repo, index| %>
            <% connected_to_this = @connected_to_this_project.include?(repo[:full_name]) %>
            <% connected_to_other = @connected_to_other_projects.include?(repo[:full_name]) %>
            <% connected = connected_to_this || connected_to_other %>
            <%# In multi mode, hide repos connected to other projects %>
            <div class="p-4 flex items-center gap-4 <%= 'app-surface-alt' if connected %> <%= 'hover:app-surface-alt transition-smooth' unless connected %>"
                 data-repo-select-target="repoItem"
                 data-repo-name="<%= repo[:full_name].downcase %>"
                 data-repo-description="<%= repo[:description]&.downcase %>"
                 data-connected-to-this="<%= connected_to_this %>"
                 data-connected-to-other="<%= connected_to_other %>">

              <%# Checkbox - hidden in single mode, visible in multi mode (not for repos connected to other projects) %>
              <% unless connected_to_other %>
                <input type="checkbox"
                       form="multi-repo-form"
                       name="repositories[<%= index %>][selected]"
                       value="1"
                       data-repo-select-target="checkbox"
                       data-action="change->repo-select#checkboxChanged"
                       data-index="<%= index %>"
                       <%= 'checked disabled' if connected_to_this %>
                       class="hidden h-5 w-5 rounded border-[color:var(--app-border-strong)] text-[color:var(--app-accent)] focus:ring-[color:var(--app-focus-ring)] disabled:opacity-50" />
              <% end %>

              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium <%= connected ? 'app-text-secondary' : 'app-text' %> truncate"><%= repo[:full_name] %></span>
                  <% if repo[:private] %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium app-surface-alt app-text-secondary">
                      Private
                    </span>
                  <% end %>
                  <% if connected_to_this %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-700">
                      Connected
                    </span>
                    <% pr = @onboarding_project.project_repositories.find_by(github_repo: repo[:full_name]) %>
                    <% if pr&.branch.present? %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium app-accent-light app-accent-text">
                        <%= pr.branch %>
                      </span>
                    <% end %>
                  <% elsif connected_to_other %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium app-surface-alt app-text-secondary">
                      In another project
                    </span>
                  <% end %>
                </div>
                <% if repo[:description].present? %>
                  <p class="text-sm app-text-secondary truncate"><%= repo[:description] %></p>
                <% end %>
              </div>

              <%# Single mode: Connect button per row %>
              <% if connected %>
                <span class="ml-4 px-4 py-2 app-surface-alt app-text-secondary text-sm rounded-lg cursor-not-allowed"
                      data-repo-select-target="connectButton">
                  <%= connected_to_this ? 'Connected' : 'Unavailable' %>
                </span>
              <% else %>
                <%= button_to "Connect",
                    connect_onboarding_project_path(@onboarding_project,
                      repositories: { "0" => { selected: "1", github_repo: repo[:full_name], installation_id: repo[:installation_id] } }),
                    method: :post,
                    class: "ml-4 px-4 py-2 bg-gradient-brand text-white text-sm rounded-lg hover:opacity-90 transition-smooth",
                    data: { turbo_frame: "_top", repo_select_target: "connectButton" } %>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Multi-select form (hidden inputs added dynamically) %>
        <%= form_with id: "multi-repo-form", url: connect_onboarding_project_path(@onboarding_project), method: :post, data: { turbo_frame: "_top", repo_select_target: "multiForm" }, class: "hidden" do |f| %>
          <% @repositories.each_with_index do |repo, index| %>
            <% connected = @connected_repos.include?(repo[:full_name]) %>
            <input type="hidden" name="repositories[<%= index %>][github_repo]" value="<%= repo[:full_name] %>" <%= 'disabled' if connected %> />
            <input type="hidden" name="repositories[<%= index %>][installation_id]" value="<%= repo[:installation_id] %>" <%= 'disabled' if connected %> />
          <% end %>
        <% end %>

        <%# Footer with toggle and multi-select submit %>
        <div class="p-4 border-t app-border app-surface-alt">
          <div class="flex items-center justify-between">
            <%= link_to "Add more repositories",
                github_app_install_path(return_to: repository_onboarding_project_path(@onboarding_project)),
                class: "app-accent-text hover:app-accent-text transition-smooth text-sm",
                data: { turbo: false } %>
            <%# Multi-mode submit button (hidden in single mode) %>
            <button type="submit"
                    form="multi-repo-form"
                    class="hidden px-6 py-2 bg-gradient-brand text-white text-sm font-medium rounded-lg hover:opacity-90 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed"
                    data-repo-select-target="submitButton">
              Continue
            </button>
          </div>
          <div class="flex items-center justify-between mt-2">
            <span class="text-xs app-text-secondary" data-repo-select-target="hint"></span>
            <button type="button"
                    data-action="repo-select#toggleMode"
                    data-repo-select-target="toggleLink"
                    class="text-xs app-text-muted hover:app-accent-text transition-smooth">
              Need to connect multiple repositories?
            </button>
          </div>
        </div>
      </div>
    <% else %>
      <%# Normal mode (not onboarding) - single connect buttons %>
      <div data-controller="repo-select">
        <%# Search input %>
        <% if @repositories.size > 5 %>
          <div class="p-4 border-b app-border">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <%= heroicon "magnifying-glass", options: { class: "h-5 w-5 app-text-muted" } %>
              </div>
              <input type="text"
                     placeholder="Search repositories..."
                     data-repo-select-target="searchInput"
                     data-action="input->repo-select#filter"
                     class="block w-full pl-10 pr-3 py-2 border app-border rounded-lg text-sm placeholder-[color:var(--app-text-muted)] focus:outline-none focus:ring-2 focus:ring-[color:var(--app-focus-ring)] focus:border-transparent" />
            </div>
          </div>
        <% end %>

        <%# No results message (hidden by default) %>
        <div class="p-8 text-center hidden" data-repo-select-target="noResults">
          <p class="app-text-secondary">No repositories match your search.</p>
        </div>

        <div class="divide-y divide-[color:var(--app-border)]" data-repo-select-target="repoList">
          <% @repositories.each do |repo| %>
            <% connected = @connected_repos.include?(repo[:full_name]) %>
            <div class="p-4 <%= 'app-surface-alt' if connected %> <%= 'hover:app-surface-alt transition-smooth' unless connected %> flex justify-between items-center"
                 data-repo-select-target="repoItem"
                 data-repo-name="<%= repo[:full_name].downcase %>"
                 data-repo-description="<%= repo[:description]&.downcase %>"
            >
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium <%= connected ? 'app-text-secondary' : 'app-text' %> truncate"><%= repo[:full_name] %></span>
                  <% if repo[:private] %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium app-surface-alt app-text-secondary">
                      Private
                    </span>
                  <% end %>
                  <% if connected %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-700">
                      Connected
                    </span>
                  <% end %>
                </div>
                <% if repo[:description].present? %>
                  <p class="text-sm app-text-secondary truncate"><%= repo[:description] %></p>
                <% end %>
              </div>

              <% if connected %>
                <span class="ml-4 px-4 py-2 app-surface-alt app-text-secondary text-sm rounded-lg cursor-not-allowed">
                  Connected
                </span>
              <% else %>
                <%= button_to "Connect",
                    projects_path(
                      github_repo: repo[:full_name],
                      installation_id: repo[:installation_id]),
                    method: :post,
                    class: "ml-4 px-4 py-2 bg-gradient-brand text-white text-sm rounded-lg hover:opacity-90 transition-smooth",
                    data: { turbo_frame: "_top" } %>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Link to add more repos %>
        <div class="p-4 text-center border-t app-border">
          <%= link_to "Add more repositories",
              github_app_install_path(return_to: new_project_path),
              class: "app-accent-text hover:app-accent-text transition-smooth text-sm",
              data: { turbo: false } %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
