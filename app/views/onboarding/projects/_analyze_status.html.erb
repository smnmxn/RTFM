<%
  # Activity stages for codebase analysis
  analysis_stages = [
    "Scanning repository structure...",
    "Reading configuration files...",
    "Identifying key components...",
    "Analyzing code patterns...",
    "Mapping dependencies...",
    "Detecting frameworks and libraries...",
    "Understanding your architecture...",
    "Building documentation outline..."
  ]

  # Activity stages for section generation
  section_stages = [
    "Understanding your product...",
    "Identifying user-facing features...",
    "Analyzing common use cases...",
    "Grouping related functionality...",
    "Prioritizing documentation topics...",
    "Finalizing section structure..."
  ]
%>

<div id="<%= dom_id(project, :onboarding_analyze) %>">
<% case project.analysis_status %>
<% when nil, "" %>
  <div class="p-6">
    <%= render "onboarding/shared/step_header",
        title: "Analyze your codebase",
        subtitle: "We'll scan your repository to understand your project." %>
    <div class="text-center py-8">
      <p class="text-slate-600 mb-4">Ready to analyze your codebase.</p>
      <%= button_to "Start Analysis",
          start_analysis_onboarding_project_path(project),
          method: :post,
          class: "btn-primary-lg" %>
    </div>
  </div>

<% when "pending", "running" %>
  <div class="p-6">
    <% if project.target_audience.present? %>
      <%# Questions answered - show progress checklist %>
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
          <%= heroicon "magnifying-glass", variant: :outline, options: { class: "w-8 h-8 text-violet-600 animate-pulse" } %>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 mb-2">Analyzing your codebase</h3>
        <p class="text-slate-500 text-sm max-w-md mx-auto">
          We're scanning your repository to understand your project structure.
        </p>
      </div>
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <%= render "onboarding/shared/loading_banner",
              stages: analysis_stages,
              stage_duration: 25,
              start_time: project.analysis_started_at,
              variant: "checklist" %>
        </div>
        <%= render "onboarding/shared/notification_prompt" %>
      </div>
    <% else %>
      <%# Questions not answered - show questions %>
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
          <%= heroicon "chat-bubble-left-right", variant: :outline, options: { class: "w-8 h-8 text-violet-600" } %>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 mb-2">Help us tailor your docs</h3>
        <p class="text-slate-500 text-sm max-w-md mx-auto">
          Answer a few quick questions while we analyze your codebase.
        </p>
      </div>
      <%= render "onboarding/projects/analysis_questions", project: project %>
    <% end %>
    <%= render "onboarding/shared/page_warning" %>
  </div>

<% when "completed" %>
  <% contextual_answers = project.user_context&.dig("contextual_answers") || {} %>
  <% has_unanswered_contextual_questions = project.contextual_questions.present? && contextual_answers.empty? %>

  <% if has_unanswered_contextual_questions %>
    <%# Contextual questions not answered - show questions (regardless of sections status) %>
    <div class="p-6">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
          <%= heroicon "chat-bubble-left-right", variant: :outline, options: { class: "w-8 h-8 text-violet-600" } %>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 mb-2">A few more questions</h3>
        <p class="text-slate-500 text-sm max-w-md mx-auto">
          Help us understand your product better while we generate topics.
        </p>
      </div>
      <%= render "onboarding/projects/contextual_questions", project: project %>
      <%= render "onboarding/shared/page_warning" %>
    </div>
  <% elsif project.sections_being_generated? %>
    <%# Sections still generating - show progress checklist %>
    <div class="p-6">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
          <%= heroicon "rectangle-stack", variant: :outline, options: { class: "w-8 h-8 text-violet-600 animate-pulse" } %>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 mb-2">Generating topics</h3>
        <p class="text-slate-500 text-sm max-w-md mx-auto">
          We're identifying the best documentation topics for your project.
        </p>
      </div>
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <%= render "onboarding/shared/loading_banner",
              stages: section_stages,
              stage_duration: 15,
              start_time: project.sections_generation_started_at,
              variant: "checklist" %>
        </div>
        <%= render "onboarding/shared/notification_prompt" %>
      </div>
      <%= render "onboarding/shared/page_warning" %>
    </div>
  <% elsif project.sections.pending.any? || project.sections.accepted.any? %>
    <div class="p-6">
      <%= render "onboarding/shared/completion_state",
          title: "Analysis complete!",
          message: "Redirecting to review your topics...",
          redirect_url: sections_onboarding_project_path(project) %>
    </div>
  <% elsif project.sections_generation_status == "failed" %>
    <div class="p-6">
      <%= render "onboarding/shared/error_state",
          message: "Couldn't generate suggestions automatically.",
          retry_path: retry_sections_onboarding_project_path(project),
          retry_text: "Retry",
          secondary_path: sections_onboarding_project_path(project),
          secondary_text: "Continue Manually" %>
    </div>
  <% else %>
    <div class="p-6">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
          <%= heroicon "rectangle-stack", variant: :outline, options: { class: "w-8 h-8 text-violet-600 animate-pulse" } %>
        </div>
        <h3 class="text-xl font-semibold text-slate-900 mb-2">Generating topics</h3>
        <p class="text-slate-500 text-sm max-w-md mx-auto">
          We're identifying the best documentation topics for your project.
        </p>
      </div>
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <%= render "onboarding/shared/loading_banner",
              stages: section_stages,
              stage_duration: 15,
              start_time: project.sections_generation_started_at,
              variant: "checklist" %>
        </div>
        <%= render "onboarding/shared/notification_prompt" %>
      </div>
      <%= render "onboarding/shared/page_warning" %>
    </div>
  <% end %>

<% when "failed" %>
  <div class="p-6">
    <%= render "onboarding/shared/error_state",
        message: "Analysis failed. Please try again.",
        retry_path: start_analysis_onboarding_project_path(project) %>
  </div>
<% end %>
</div>
