<% questions = project.contextual_questions || [] %>
<% return if questions.empty? %>

<% contextual_answers = project.user_context&.dig("contextual_answers") || {} %>
<% if contextual_answers.any? %>
  <!-- Already answered - show completion state -->
  <div class="bg-slate-50 rounded-lg p-6 text-center">
    <%= heroicon "check-circle", options: { class: "h-8 w-8 text-emerald-500 mx-auto mb-3" } %>
    <p class="text-slate-900 font-medium mb-1">Thanks for your answers!</p>
    <p class="text-slate-500 text-sm">We're generating help topic suggestions based on your project. This usually takes 1–2 minutes.</p>
  </div>
<% else %>
<div data-controller="contextual-questions"
     data-contextual-questions-save-url-value="<%= save_context_onboarding_project_path(project) %>"
     data-contextual-questions-total-value="<%= questions.size %>">

  <div class="mb-4">
    <h3 class="text-base font-semibold text-slate-900 mb-1">
      A few questions about your project
    </h3>
    <p class="text-sm text-slate-500">
      We spotted a few things in your codebase we'd love to know more about.
      Your answers help us write more relevant help content. Skip any you're not sure about.
    </p>
  </div>

  <div class="bg-slate-50 rounded-lg p-4">
    <div class="relative overflow-hidden" style="min-height: 400px;">
      <% questions.each_with_index do |question, index| %>
      <div data-contextual-questions-target="card"
           data-question-id="<%= question['id'] %>"
           data-multi-select="<%= question['multi_select'] %>"
           class="question-card absolute inset-0 transition-transform duration-300 ease-in-out <%= index > 0 ? 'translate-x-full' : '' %>">
        <h3 class="text-base font-medium text-slate-900 mb-3"><%= question['question'] %></h3>

        <div class="space-y-2">
          <% if question['input_type'] == 'text' %>
            <textarea name="<%= question['id'] %>"
                      rows="3"
                      placeholder="Type your answer..."
                      class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-smooth"
                      data-contextual-questions-target="textInput"
                      data-action="input->contextual-questions#onTextInput"></textarea>
          <% else %>
            <% (question['options'] || []).each do |option| %>
              <label class="flex items-center p-3 bg-white border border-slate-300 rounded-lg shadow-sm cursor-pointer hover:bg-slate-50 hover:border-slate-400 transition-smooth"
                     data-action="click->contextual-questions#selectOption">
                <% if question['multi_select'] %>
                  <input type="checkbox"
                         name="<%= question['id'] %>[]"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-violet-600 border-slate-300 rounded focus:ring-violet-500"
                         data-contextual-questions-target="checkbox">
                <% else %>
                  <input type="radio"
                         name="<%= question['id'] %>"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-violet-600 border-slate-300 focus:ring-violet-500"
                         data-contextual-questions-target="radio">
                <% end %>
                <span class="ml-3 text-slate-700"><%= option['label'] %></span>
              </label>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Completion Card -->
    <div data-contextual-questions-target="completionCard"
         class="absolute inset-0 transition-transform duration-300 ease-in-out translate-x-full flex flex-col items-center justify-center text-center">
      <%= spinner_icon(size: "h-8 w-8", color: "text-violet-600", extra_class: "mb-4") %>
      <p class="text-slate-900 font-medium mb-1">Thanks for that!</p>
      <p class="text-slate-500 text-sm">We're generating help topic suggestions based on your project. This usually takes 1–2 minutes.</p>
    </div>
    </div>

    <!-- Navigation -->
    <div class="mt-4 flex items-center justify-between">
    <button type="button"
            data-action="click->contextual-questions#skip"
            data-contextual-questions-target="skipButton"
            class="text-sm text-slate-500 hover:text-slate-700 transition-smooth">
      Skip
    </button>

    <div class="flex space-x-2" data-contextual-questions-target="dots">
      <% questions.size.times do |i| %>
        <span class="h-1.5 w-1.5 rounded-full transition-smooth <%= i == 0 ? 'bg-violet-600' : 'bg-slate-300' %>"
              data-contextual-questions-target="dot"></span>
      <% end %>
    </div>

    <button type="button"
            data-action="click->contextual-questions#next"
            data-contextual-questions-target="nextButton"
            class="px-4 py-2 text-sm font-medium text-white bg-gradient-brand rounded-lg hover:opacity-90 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
        Next
      </button>
    </div>
  </div>
</div>
<% end %>
