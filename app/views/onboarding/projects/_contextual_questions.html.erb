<% questions = project.contextual_questions || [] %>
<% return if questions.empty? %>

<div data-controller="contextual-questions"
     data-contextual-questions-save-url-value="<%= save_context_onboarding_project_path(project) %>"
     data-contextual-questions-total-value="<%= questions.size %>">

  <div class="relative overflow-hidden" style="min-height: 340px;">
    <% questions.each_with_index do |question, index| %>
      <div data-contextual-questions-target="card"
           data-question-id="<%= question['id'] %>"
           data-multi-select="<%= question['multi_select'] %>"
           class="question-card absolute inset-0 transition-transform duration-300 ease-in-out <%= index > 0 ? 'translate-x-full' : '' %>">
        <h3 class="text-lg font-medium text-slate-900 mb-4"><%= question['question'] %></h3>

        <div class="space-y-2">
          <% if question['input_type'] == 'text' %>
            <textarea name="<%= question['id'] %>"
                      rows="3"
                      placeholder="Type your answer..."
                      class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-smooth"
                      data-contextual-questions-target="textInput"
                      data-action="input->contextual-questions#onTextInput"></textarea>
          <% else %>
            <% (question['options'] || []).each do |option| %>
              <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 hover:border-slate-300 transition-smooth"
                     data-action="click->contextual-questions#selectOption">
                <% if question['multi_select'] %>
                  <input type="checkbox"
                         name="<%= question['id'] %>[]"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-violet-600 border-slate-300 rounded focus:ring-violet-500"
                         data-contextual-questions-target="checkbox">
                <% else %>
                  <input type="radio"
                         name="<%= question['id'] %>"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-violet-600 border-slate-300 focus:ring-violet-500"
                         data-contextual-questions-target="radio">
                <% end %>
                <span class="ml-3 text-slate-700"><%= option['label'] %></span>
              </label>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Completion Card -->
    <div data-contextual-questions-target="completionCard"
         class="absolute inset-0 transition-transform duration-300 ease-in-out translate-x-full flex flex-col items-center justify-center text-center">
      <svg class="animate-spin h-8 w-8 text-violet-600 mb-3" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-slate-600">Just a moment...</p>
    </div>
  </div>

  <!-- Navigation -->
  <div class="mt-5 flex items-center justify-between">
    <button type="button"
            data-action="click->contextual-questions#skip"
            data-contextual-questions-target="skipButton"
            class="text-sm text-slate-500 hover:text-slate-700 transition-smooth">
      Skip
    </button>

    <div class="flex space-x-2" data-contextual-questions-target="dots">
      <% questions.size.times do |i| %>
        <span class="h-1.5 w-1.5 rounded-full transition-smooth <%= i == 0 ? 'bg-violet-600' : 'bg-slate-300' %>"
              data-contextual-questions-target="dot"></span>
      <% end %>
    </div>

    <button type="button"
            data-action="click->contextual-questions#next"
            data-contextual-questions-target="nextButton"
            class="px-4 py-2 text-sm font-medium text-white bg-gradient-brand rounded-lg hover:opacity-90 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
      Next
    </button>
  </div>
</div>
