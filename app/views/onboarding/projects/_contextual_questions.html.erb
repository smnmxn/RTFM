<% questions = project.contextual_questions || [] %>
<% return if questions.empty? %>

<% contextual_answers = project.user_context&.dig("contextual_answers") || {} %>
<% if contextual_answers.any? %>
  <!-- Already answered - show completed questions -->
  <%= render "onboarding/shared/completed_questions",
      questions: completed_contextual_questions(project) %>
<% else %>
<div data-controller="contextual-questions"
     data-contextual-questions-save-url-value="<%= save_context_onboarding_project_path(project) %>"
     data-contextual-questions-total-value="<%= questions.size %>">
  <div class="app-surface-alt rounded-lg p-4">
    <div class="relative overflow-hidden" style="min-height: 400px;">
      <% questions.each_with_index do |question, index| %>
      <div data-contextual-questions-target="card"
           data-question-id="<%= question['id'] %>"
           data-multi-select="<%= question['multi_select'] %>"
           class="question-card absolute inset-0 transition-transform duration-300 ease-in-out <%= index > 0 ? 'translate-x-full' : '' %>">
        <h3 class="text-base font-medium app-text mb-3"><%= question['question'] %></h3>

        <div class="space-y-2">
          <% if question['input_type'] == 'text' %>
            <textarea name="<%= question['id'] %>"
                      rows="3"
                      placeholder="Type your answer..."
                      class="w-full px-3 py-2 border app-border rounded-lg focus:ring-2 focus:ring-[color:var(--app-focus-ring)] focus:border-[color:var(--app-accent)] transition-smooth"
                      data-contextual-questions-target="textInput"
                      data-action="input->contextual-questions#onTextInput"></textarea>
          <% else %>
            <% (question['options'] || []).each do |option| %>
              <label class="flex items-center p-3 app-surface border app-border-strong rounded-lg shadow-sm cursor-pointer hover:app-surface-alt hover:app-border-strong transition-smooth"
                     data-action="click->contextual-questions#selectOption">
                <% if question['multi_select'] %>
                  <input type="checkbox"
                         name="<%= question['id'] %>[]"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-[color:var(--app-accent)] border-[color:var(--app-border-strong)] rounded focus:ring-[color:var(--app-focus-ring)]"
                         data-contextual-questions-target="checkbox">
                <% else %>
                  <input type="radio"
                         name="<%= question['id'] %>"
                         value="<%= option['value'] %>"
                         class="h-4 w-4 text-[color:var(--app-accent)] border-[color:var(--app-border-strong)] focus:ring-[color:var(--app-focus-ring)]"
                         data-contextual-questions-target="radio">
                <% end %>
                <span class="ml-3 app-text"><%= option['label'] %></span>
              </label>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Completion Card -->
    <div data-contextual-questions-target="completionCard"
         class="absolute inset-0 transition-transform duration-300 ease-in-out translate-x-full flex flex-col items-center justify-center text-center">
      <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-4">
        <%= heroicon "check-circle", variant: :solid, options: { class: "w-6 h-6 text-green-600" } %>
      </div>
      <p class="app-text font-medium mb-1">Thanks for that!</p>
      <p class="app-text-secondary text-sm">We're generating help topic suggestions based on your project.</p>
    </div>
    </div>

    <!-- Navigation -->
    <div class="mt-4 flex items-center justify-between">
    <button type="button"
            data-action="click->contextual-questions#skip"
            data-contextual-questions-target="skipButton"
            class="text-sm app-text-secondary hover:app-text transition-smooth">
      Skip
    </button>

    <div class="flex space-x-2" data-contextual-questions-target="dots">
      <% questions.size.times do |i| %>
        <span class="h-1.5 w-1.5 rounded-full transition-smooth <%= i == 0 ? 'app-accent-bg' : 'app-border-strong' %>"
              data-contextual-questions-target="dot"></span>
      <% end %>
    </div>

    <button type="button"
            data-action="click->contextual-questions#next"
            data-contextual-questions-target="nextButton"
            class="btn-primary-sm disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
        Next
      </button>
    </div>
  </div>
</div>
<% end %>
