<div class="bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden">
  <%= render "onboarding/shared/step_header",
      title: "Set up your help centre",
      subtitle: "Choose a name, URL, and which branch to track for each repository." %>

  <div class="p-6">
    <%= form_with url: save_setup_onboarding_project_path(@project), method: :post, class: "space-y-6" do |f| %>
      <div>
        <label for="project_name" class="block text-sm font-medium text-slate-700 mb-1">Project name</label>
        <input type="text" name="project[name]" id="project_name"
               value="<%= @project.name == 'New Project' ? '' : @project.name %>"
               class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
               placeholder="My App"
               autofocus
               required />
        <p class="mt-1 text-xs text-slate-500">This will be displayed in your help centre header.</p>
        <% if @project.errors[:name].any? %>
          <p class="mt-1 text-xs text-red-600"><%= @project.errors[:name].first %></p>
        <% end %>
      </div>

      <div>
        <label for="project_subdomain" class="block text-sm font-medium text-slate-700 mb-1">Subdomain</label>
        <div class="flex items-center">
          <input type="text" name="project[subdomain]" id="project_subdomain"
                 value="<%= @project.subdomain %>"
                 class="flex-1 px-3 py-2 border border-slate-300 rounded-l-lg shadow-sm focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                 placeholder="my-app"
                 pattern="[a-z0-9][a-z0-9-]*[a-z0-9]"
                 minlength="3"
                 maxlength="63"
                 required />
          <span class="px-3 py-2 bg-slate-100 border border-l-0 border-slate-300 rounded-r-lg text-slate-500 text-sm">
            .supportpages.io
          </span>
        </div>
        <p class="mt-1 text-xs text-slate-500">Lowercase letters, numbers, and hyphens only. This will be your help centre URL.</p>
        <% if @project.errors[:subdomain].any? %>
          <p class="mt-1 text-xs text-red-600"><%= @project.errors[:subdomain].first %></p>
        <% end %>
        <% if @project.errors[:slug].any? %>
          <p class="mt-1 text-xs text-red-600"><%= @project.errors[:slug].first %></p>
        <% end %>
      </div>

      <% if @project_repositories.any? %>
        <div class="border-t border-slate-200 pt-6">
          <h3 class="text-sm font-medium text-slate-700 mb-3">Branch to track</h3>
          <p class="text-xs text-slate-500 mb-4">Choose which branch to monitor for each repository. Only pull requests merged into this branch will trigger documentation updates.</p>

          <div class="space-y-4">
            <% @project_repositories.each do |pr| %>
              <% repo_data = @branches_by_repo[pr.id] || { branches: [], default_branch: nil } %>
              <div class="flex items-center gap-4">
                <div class="flex-1 min-w-0">
                  <span class="text-sm font-medium text-slate-900 truncate block"><%= pr.github_repo %></span>
                </div>
                <div class="w-48">
                  <% if repo_data[:branches].any? %>
                    <select name="repo_branches[<%= pr.id %>]"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                      <% repo_data[:branches].each do |branch| %>
                        <option value="<%= branch %>"
                                <%= 'selected' if branch == (pr.branch || repo_data[:default_branch]) %>>
                          <%= branch %><%= ' (default)' if branch == repo_data[:default_branch] %>
                        </option>
                      <% end %>
                    </select>
                  <% else %>
                    <input type="text" name="repo_branches[<%= pr.id %>]"
                           value="<%= pr.branch || 'main' %>"
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                           placeholder="main" />
                    <p class="mt-1 text-xs text-slate-400">Could not load branches</p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="pt-4">
        <button type="submit" class="w-full btn-primary-lg cursor-pointer">Continue</button>
      </div>
    <% end %>
  </div>
</div>
