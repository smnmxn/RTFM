<!DOCTYPE html>
<html class="scroll-smooth <%= 'dark' if @project.dark_mode_enabled? %>">
  <head>
    <title><%= content_for(:title) || "#{@project.name} #{@project.help_centre_title_or_default}" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# Nunito Sans (body) + Raleway (headlines) %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;500;600;700&family=Raleway:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Dynamic branding colors -->
    <style>
      :root {
        --brand-primary: <%= @project.primary_color_or_default %>;
        --brand-accent: <%= @project.accent_color_or_default %>;
        --brand-title: <%= @project.title_text_color_or_default %>;

        --font-body: 'Nunito Sans', system-ui, sans-serif;
        --font-display: 'Raleway', system-ui, sans-serif;

        /* Light mode semantic colors */
        --bg-primary: #f9fafb;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --border-color: #e5e7eb;
        --border-light: #f3f4f6;
      }

      .dark {
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --bg-tertiary: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --text-tertiary: #6b7280;
        --border-color: #374151;
        --border-light: #1f2937;
      }

      /* Brand color utilities */
      .text-brand { color: var(--brand-primary); }
      .text-brand-title { color: var(--brand-title); }
      .bg-brand { background-color: var(--brand-primary); }
      .border-brand { border-color: var(--brand-primary); }
      .bg-brand-light { background-color: color-mix(in srgb, var(--brand-primary) 15%, var(--bg-secondary)); }

      /* Semantic color utilities */
      .bg-surface { background-color: var(--bg-primary); }
      .bg-card { background-color: var(--bg-secondary); }
      .bg-muted { background-color: var(--bg-tertiary); }
      .text-heading { color: var(--text-primary); }
      .text-body { color: var(--text-secondary); }
      .text-muted { color: var(--text-tertiary); }
      .border-default { border-color: var(--border-color); }
      .border-subtle { border-color: var(--border-light); }

      /* Hover states */
      .hover\:text-brand:hover { color: var(--brand-primary); }
      .hover\:bg-brand:hover { background-color: var(--brand-primary); }
      .hover\:border-brand:hover { border-color: var(--brand-primary); }
      .hover\:bg-muted:hover { background-color: var(--bg-tertiary); }
      .group:hover .group-hover\:text-brand { color: var(--brand-primary); }
      .group:hover .group-hover\:bg-brand { background-color: var(--brand-primary); }
      .group:hover .group-hover\:bg-brand-light { background-color: color-mix(in srgb, var(--brand-primary) 15%, var(--bg-secondary)); }

      /* Focus states */
      .focus\:ring-brand:focus { --tw-ring-color: var(--brand-primary); }
      .focus\:border-brand:focus { border-color: var(--brand-primary); }

      /* Icon hover - ensure white text overrides brand color */
      .group:hover .group-hover\:text-white { color: white !important; }

      /* Font utilities */
      .font-display { font-family: var(--font-display); }
      .font-body { font-family: var(--font-body); }

      /* State colors using color-mix for dark mode compatibility */
      .bg-warning-soft { background-color: color-mix(in srgb, #f59e0b 10%, var(--bg-secondary)); }
      .text-warning-strong { color: color-mix(in srgb, #f59e0b 80%, var(--text-primary)); }
      .text-warning { color: color-mix(in srgb, #f59e0b 60%, var(--text-secondary)); }
      .border-warning { border-color: color-mix(in srgb, #f59e0b 30%, var(--border-color)); }

      .bg-error-soft { background-color: color-mix(in srgb, #ef4444 10%, var(--bg-secondary)); }
      .text-error-strong { color: color-mix(in srgb, #ef4444 80%, var(--text-primary)); }
      .text-error { color: color-mix(in srgb, #ef4444 60%, var(--text-secondary)); }
      .border-error { border-color: color-mix(in srgb, #ef4444 30%, var(--border-color)); }

      .text-success { color: color-mix(in srgb, #22c55e 80%, var(--text-primary)); }

      /* Brand-tinted tips */
      .bg-tips { background-color: color-mix(in srgb, var(--brand-primary) 8%, var(--bg-secondary)); }
      .text-tips-heading { color: color-mix(in srgb, var(--brand-primary) 80%, var(--text-primary)); }
      .text-tips-body { color: color-mix(in srgb, var(--brand-primary) 50%, var(--text-primary)); }
      .text-tips-icon { color: color-mix(in srgb, var(--brand-primary) 60%, var(--text-secondary)); }

      /* Hover feedback states */
      .hover\:bg-success-soft:hover { background-color: color-mix(in srgb, #22c55e 8%, var(--bg-secondary)); }
      .hover\:border-success:hover { border-color: color-mix(in srgb, #22c55e 40%, var(--border-color)); }
      .hover\:text-success:hover { color: color-mix(in srgb, #22c55e 80%, var(--text-primary)); }
      .hover\:bg-error-soft:hover { background-color: color-mix(in srgb, #ef4444 8%, var(--bg-secondary)); }
      .hover\:border-error:hover { border-color: color-mix(in srgb, #ef4444 40%, var(--border-color)); }
      .hover\:text-error:hover { color: color-mix(in srgb, #ef4444 80%, var(--text-primary)); }

      /* Cursor blink animation */
      @keyframes cursor-blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
      }
      .animate-cursor-blink { animation: cursor-blink 0.8s ease-in-out infinite; }
    </style>

    <% if @project.logo.attached? %>
      <link rel="icon" href="<%= url_for(@project.logo) %>" type="<%= @project.logo.content_type %>">
    <% else %>
      <link rel="icon" href="/icon.png" type="image/png">
      <link rel="icon" href="/icon.svg" type="image/svg+xml">
      <link rel="apple-touch-icon" href="/icon.png">
    <% end %>

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="min-h-screen bg-surface flex flex-col" style="font-family: var(--font-body);">
    <header class="bg-card/95 backdrop-blur-sm shadow-sm sticky top-0 z-50 border-b border-default">
      <div class="max-w-6xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <% if @project.logo.attached? %>
            <%= link_to help_centre_path(project_slug: @project.slug), class: "hover:opacity-80 transition-opacity" do %>
              <%= image_tag @project.logo, class: "h-10 object-contain", alt: @project.name %>
            <% end %>
          <% else %>
            <div>
              <h1 class="text-xl font-bold">
                <%= link_to @project.name, help_centre_path(project_slug: @project.slug),
                    class: "hover:opacity-80 transition-opacity",
                    style: "color: var(--brand-primary)" %>
              </h1>
              <p class="text-sm text-body"><%= @project.help_centre_title_or_default %></p>
            </div>
          <% end %>
        </div>

        <div class="flex items-center gap-4">
          <% unless content_for?(:hero) %>
            <!-- Mini ask on non-index pages -->
            <%= form_with url: help_centre_ask_path,
                          method: :get,
                          class: "hidden sm:block" do %>
              <div class="relative">
                <input type="text"
                       name="q"
                       placeholder="Ask a question..."
                       class="w-48 lg:w-64 focus:w-56 lg:focus:w-80 px-4 py-2 pl-10 text-sm border border-default rounded-lg bg-card text-heading placeholder:text-muted
                              focus:ring-2 focus:ring-brand focus:border-brand transition-all duration-300">
                <%= heroicon "sparkles", options: { class: "absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted" } %>
              </div>
            <% end %>
          <% end %>

          <% if @project.has_support_contact? %>
            <% if @project.support_email.present? && @project.support_phone.present? %>
              <!-- Dropdown when both contact methods available -->
              <div class="relative" data-controller="dropdown">
                <button type="button"
                        data-action="click->dropdown#toggle"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-heading rounded-lg border border-default hover:bg-muted transition-colors">
                  <%= heroicon "chat-bubble-left-right", options: { class: "w-4 h-4 text-body" } %>
                  <span class="hidden sm:inline">Contact Support</span>
                  <%= heroicon "chevron-down", options: { class: "w-3 h-3 text-muted" } %>
                </button>
                <div data-dropdown-target="menu"
                     class="hidden absolute right-0 mt-2 w-48 bg-card rounded-lg shadow-lg border border-default py-1 z-50">
                  <%= link_to "mailto:#{@project.support_email}",
                      class: "flex items-center gap-2 px-4 py-2 text-sm text-heading hover:bg-muted" do %>
                    <%= heroicon "envelope", options: { class: "w-4 h-4 text-muted" } %>
                    <%= @project.support_email %>
                  <% end %>
                  <%= link_to "tel:#{@project.support_phone}",
                      class: "flex items-center gap-2 px-4 py-2 text-sm text-heading hover:bg-muted" do %>
                    <%= heroicon "phone", options: { class: "w-4 h-4 text-muted" } %>
                    <%= @project.support_phone %>
                  <% end %>
                </div>
              </div>
            <% elsif @project.support_email.present? %>
              <%= link_to "mailto:#{@project.support_email}",
                  class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-heading rounded-lg border border-default hover:bg-muted transition-colors" do %>
                <%= heroicon "envelope", options: { class: "w-4 h-4 text-body" } %>
                <span class="hidden sm:inline">Contact Support</span>
              <% end %>
            <% else %>
              <%= link_to "tel:#{@project.support_phone}",
                  class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-heading rounded-lg border border-default hover:bg-muted transition-colors" do %>
                <%= heroicon "phone", options: { class: "w-4 h-4 text-body" } %>
                <span class="hidden sm:inline"><%= @project.support_phone %></span>
              <% end %>
            <% end %>
          <% end %>

          <% base_domain = Rails.application.config.x.base_domain %>
          <% protocol = Rails.env.production? ? "https" : "http" %>
          <% app_url = "#{protocol}://app.#{base_domain}" %>
          <% if logged_in? %>
            <% edit_url = @article ? "#{app_url}/projects/#{@project.slug}?article=#{@article.id}" : "#{app_url}/projects/#{@project.slug}" %>
            <%= link_to edit_url, class: "text-sm text-body hover:text-heading" do %>
              Edit
            <% end %>
          <% end %>
        </div>
      </div>
    </header>

    <%= yield :hero %>

    <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-8 flex-1 w-full">
      <%= yield %>
    </main>

    <footer class="bg-muted mt-auto border-t border-default relative">
      <div class="absolute top-0 left-0 right-0 h-px" style="background: linear-gradient(to right, transparent, var(--brand-primary), transparent); opacity: 0.3;"></div>
      <div class="max-w-6xl mx-auto px-4 py-6 sm:px-6 lg:px-8 text-center text-sm text-body space-y-1">
        <p>Powered by <a href="/" style="color: var(--brand-primary)" class="hover:opacity-80">supportpages.io</a></p>
        <p class="text-muted text-xs">&copy; <%= Date.current.year %> Surface Layer Limited (Company No. 17026012) | 128 City Road, London, EC1V 2NX</p>
      </div>
    </footer>
  </body>
</html>
